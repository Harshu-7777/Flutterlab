import 'dart:async';
import 'dart:math';
import 'package:flutter/material.dart';

void main() {
  runApp(const NetfliXCloneApp());
}

// --- Data Model ---

class Movie {
  final int id;
  final String title;
  final int year;
  final List<String> genres;
  final double rating;
  final String description;
  final String posterUrl;
  final int durationSeconds;
  final double? watchedPercentage;

  Movie({
    required this.id,
    required this.title,
    required this.year,
    required this.genres,
    required this.rating,
    required this.description,
    required this.posterUrl,
    required this.durationSeconds,
    this.watchedPercentage,
  });
}

// --- App State & Main Widget ---

class NetfliXCloneApp extends StatelessWidget {
  const NetfliXCloneApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Netflix Clone',
      debugShowCheckedModeBanner: false,
      theme: ThemeData(
        brightness: Brightness.dark,
        primarySwatch: Colors.red,
        scaffoldBackgroundColor: Colors.black,
        appBarTheme: const AppBarTheme(
          backgroundColor: Colors.black,
          elevation: 0,
        ),
      ),
      home: const HomeScreen(),
    );
  }
}

class HomeScreen extends StatefulWidget {
  const HomeScreen({super.key});

  @override
  State<HomeScreen> createState() => _HomeState();
}

class _HomeState extends State<HomeScreen> {
  // Updated in-memory data store with unique movies
  final List<Movie> sampleMovies = [
    Movie(
      id: 1,
      title: 'Dune: Part Two',
      year: 2024,
      genres: ['Sci-Fi', 'Action', 'Adventure'],
      rating: 8.8,
      description: 'Paul Atreides unites with Chani and the Fremen while seeking revenge against the conspirators who destroyed his family.',
      posterUrl: 'https://image.tmdb.org/t/p/w500/d5NXSklXo0qyIYkgV94XAgMIckC.jpg',
      durationSeconds: 9960,
      watchedPercentage: 45.0,
    ),
    Movie(
      id: 2,
      title: 'RRR',
      year: 2022,
      genres: ['Action', 'Drama', 'Adventure'],
      rating: 8.0,
      description: 'A fictional story about two Indian revolutionaries, their friendship and their fight against the British Raj.',
      posterUrl: 'https://image.tmdb.org/t/p/w500/wE0I6efAW4cDDmZQWtwZMOW44EJ.jpg',
      durationSeconds: 12000,
    ),
    Movie(
      id: 3,
      title: 'Queen of Tears',
      year: 2024,
      genres: ['Romance', 'Drama'],
      rating: 8.9,
      description: 'The story of a married couple who face a crisis and must rekindle their love for each other.',
      posterUrl: 'https://m.media-amazon.com/images/M/MV5BNWNmYmQ2NzctNTA1NS00NGU2LThjOTQtYTgxNmUyYmNjODYyXkEyXkFqcGc@._V1_.jpg',
      durationSeconds: 43200,
    ),
    Movie(
      id: 4,
      title: 'When I Fly Towards You',
      year: 2023,
      genres: ['Romance', 'Drama'],
      rating: 8.7,
      description: 'A heartwarming story of young love and the journey of self-discovery during high school years.',
      posterUrl: 'https://m.media-amazon.com/images/M/MV5BODI3NzUwYTktMjlkYS00MDNiLTg0MjgtNWQ1NWZkYmQ2Mzk4XkEyXkFqcGc@._V1_.jpg',
      durationSeconds: 28800,
    ),
    Movie(
      id: 5,
      title: 'Sahoo',
      year: 2019,
      genres: ['Action', 'Thriller'],
      rating: 7.5,
      description: 'A man with a mysterious past arrives in Mumbai and gets caught in a web of crime and deception.',
      posterUrl: 'https://m.media-amazon.com/images/M/MV5BYmNlM2NkNzEtODAwOS00MTFjLTljODAtNjJjODdhZjI5MGYzXkEyXkFqcGc@._V1_FMjpg_UX1000_.jpg',
      durationSeconds: 8340,
    ),
    Movie(
      id: 6,
      title: 'John Wick: Chapter 4',
      year: 2023,
      genres: ['Action', 'Crime', 'Thriller'],
      rating: 7.7,
      description: 'John Wick uncovers a path to defeating The High Table. But before he can earn his freedom, Wick must face off against a new enemy.',
      posterUrl: 'https://image.tmdb.org/t/p/w500/vZloFAK7NmvMGKE7VkF5UHaz0I.jpg',
      durationSeconds: 10140,
    ),
    Movie(
      id: 7,
      title: 'Mission: Impossible - Dead Reckoning',
      year: 2023,
      genres: ['Action', 'Adventure', 'Thriller'],
      rating: 7.8,
      description: 'Ethan Hunt and his IMF team must track down a terrifying new weapon that threatens all of humanity.',
      posterUrl: 'https://image.tmdb.org/t/p/w500/NNxYkU70HPurnNCSiCjYAmacwm.jpg',
      durationSeconds: 9840,
    ),
    Movie(
      id: 8,
      title: 'The Batman',
      year: 2022,
      genres: ['Action', 'Crime', 'Drama'],
      rating: 7.8,
      description: 'When a sadistic serial killer begins murdering key political figures in Gotham, Batman is forced to investigate the city\'s hidden corruption.',
      posterUrl: 'https://image.tmdb.org/t/p/w500/74xTEgt7R36Fpooo50r9T25onhq.jpg',
      durationSeconds: 10560,
    ),
    Movie(
      id: 9,
      title: 'Avatar: The Way of Water',
      year: 2022,
      genres: ['Sci-Fi', 'Adventure', 'Action'],
      rating: 7.6,
      description: 'Jake Sully lives with his newfound family formed on the planet of Pandora. Once a familiar threat returns to finish what was previously started.',
      posterUrl: 'https://image.tmdb.org/t/p/w500/t6HIqrRAclMCA60NsSmeqe9RmNV.jpg',
      durationSeconds: 11520,
    ),
    Movie(
      id: 10,
      title: 'Black Panther: Wakanda Forever',
      year: 2022,
      genres: ['Action', 'Adventure', 'Drama'],
      rating: 7.1,
      description: 'The people of Wakanda fight to protect their home from intervening world powers as they mourn the death of King T\'Challa.',
      posterUrl: 'https://image.tmdb.org/t/p/w500/sv1xJUazXeYqALzczSZ3O6nkH75.jpg',
      durationSeconds: 9660,
    ),
    Movie(
      id: 11,
      title: 'Stranger Things',
      year: 2016,
      genres: ['Sci-Fi', 'Horror', 'Drama'],
      rating: 8.7,
      description: 'When a young boy vanishes, a small town uncovers a mystery involving secret experiments, terrifying supernatural forces and one strange little girl.',
      posterUrl: 'https://image.tmdb.org/t/p/w500/49WJfeN0moxb9IPfGn8AIqMGskD.jpg',
      durationSeconds: 28800,
    ),
    Movie(
      id: 12,
      title: 'The Crown',
      year: 2016,
      genres: ['Drama', 'History'],
      rating: 8.6,
      description: 'The reign of Queen Elizabeth II of the United Kingdom and the events that shaped the second half of the 20th century.',
      posterUrl: 'https://image.tmdb.org/t/p/w500/1M876KPjulVwppEpldhdc8V4o68.jpg',
      durationSeconds: 36000,
    ),
    Movie(
      id: 13,
      title: 'Breaking Bad',
      year: 2008,
      genres: ['Crime', 'Drama', 'Thriller'],
      rating: 9.5,
      description: 'A high school chemistry teacher diagnosed with cancer turns to a life of crime to secure his family\'s future.',
      posterUrl: 'https://image.tmdb.org/t/p/w500/3xnWaLQjelJDDF7LT1WBo6f4BRe.jpg',
      durationSeconds: 28800,
    ),
    Movie(
      id: 14,
      title: 'The Witcher',
      year: 2019,
      genres: ['Fantasy', 'Action', 'Adventure'],
      rating: 8.0,
      description: 'Geralt of Rivia, a mutated monster-hunter for hire, journeys toward his destiny in a turbulent world where people often prove more wicked than beasts.',
      posterUrl: 'https://image.tmdb.org/t/p/w500/7vjaCdMw15FEbXyLQTVa04URsPm.jpg',
      durationSeconds: 28800,
    ),
    Movie(
      id: 15,
      title: 'Money Heist',
      year: 2017,
      genres: ['Crime', 'Drama', 'Thriller'],
      rating: 8.3,
      description: 'Eight thieves take hostages and lock themselves in the Royal Mint of Spain as a criminal mastermind manipulates the police to carry out his plan.',
      posterUrl: 'https://image.tmdb.org/t/p/w500/reEMJA1uzscCbkpeRJeTT2bjqUp.jpg',
      durationSeconds: 28800,
    ),
    // Additional movies for Top Picks
    Movie(
      id: 16,
      title: 'Oppenheimer',
      year: 2023,
      genres: ['Drama', 'History', 'Biography'],
      rating: 8.4,
      description: 'The story of American scientist J. Robert Oppenheimer and his role in the development of the atomic bomb.',
      posterUrl: 'https://image.tmdb.org/t/p/w500/8Gxv8gSFCU0XGDykEGv7zR1n2ua.jpg',
      durationSeconds: 10800,
    ),
    Movie(
      id: 17,
      title: 'Barbie',
      year: 2023,
      genres: ['Comedy', 'Adventure', 'Fantasy'],
      rating: 7.8,
      description: 'Barbie and Ken are having the time of their lives in the colorful and seemingly perfect world of Barbie Land.',
      posterUrl: 'https://image.tmdb.org/t/p/w500/iuFNMS8U5cb6xfzi51Dbkovj7vM.jpg',
      durationSeconds: 6840,
    ),
    // Additional movies for Action & Adventure
    Movie(
      id: 18,
      title: 'Mad Max: Fury Road',
      year: 2015,
      genres: ['Action', 'Adventure', 'Sci-Fi'],
      rating: 8.1,
      description: 'In a post-apocalyptic wasteland, a woman rebels against a tyrannical ruler in search for her homeland.',
      posterUrl: 'https://image.tmdb.org/t/p/w500/8tZYtuWezp8JbcsvHYO0O46tFbo.jpg',
      durationSeconds: 7200,
    ),
    Movie(
      id: 19,
      title: 'Avengers: Endgame',
      year: 2019,
      genres: ['Action', 'Adventure', 'Sci-Fi'],
      rating: 8.4,
      description: 'After the devastating events of Infinity War, the Avengers assemble once more to reverse Thanos\' actions.',
      posterUrl: 'https://image.tmdb.org/t/p/w500/or06FN3Dka5tukK1e9sl16pB3iy.jpg',
      durationSeconds: 10680,
    ),
    Movie(
      id: 20,
      title: 'Spider-Man: No Way Home',
      year: 2021,
      genres: ['Action', 'Adventure', 'Sci-Fi'],
      rating: 8.2,
      description: 'With Spider-Man\'s identity now revealed, Peter asks Doctor Strange for help, unleashing the multiverse.',
      posterUrl: 'https://image.tmdb.org/t/p/w500/1g0dhYtq4irTY1GPXvft6k4YLjm.jpg',
      durationSeconds: 8880,
    ),
    // Additional movies for Your Watchlist
    Movie(
      id: 21,
      title: 'The Queen\'s Gambit',
      year: 2020,
      genres: ['Drama'],
      rating: 8.6,
      description: 'Orphaned at a young age, a chess prodigy struggles with addiction while transforming the chess world.',
      posterUrl: 'https://image.tmdb.org/t/p/w500/zU0htwkhNvBQdVSIKB9s6hgVeFK.jpg',
      durationSeconds: 23400,
    ),
    Movie(
      id: 22,
      title: 'Squid Game',
      year: 2021,
      genres: ['Thriller', 'Drama', 'Action'],
      rating: 8.3,
      description: 'Hundreds of cash-strapped players accept a strange invitation to compete in children\'s games for a tempting prize.',
      posterUrl: 'https://image.tmdb.org/t/p/w500/dDlEmu3EZ0Pgg93K2SVNLCjCSvE.jpg',
      durationSeconds: 28800,
    ),
    Movie(
      id: 23,
      title: 'Wednesday',
      year: 2022,
      genres: ['Comedy', 'Crime', 'Fantasy'],
      rating: 8.4,
      description: 'Follows Wednesday Addams\' years as a student, when she attempts to master her emerging psychic ability.',
      posterUrl: 'https://image.tmdb.org/t/p/w500/9PFonBhy4cQy7Jz20NpMygczOkv.jpg',
      durationSeconds: 21600,
    ),
  ];

  // Global app state
  final Set<int> _myList = {};
  final Set<int> _liked = {};
  Movie? _currentlyPlaying;
  double _playbackPosition = 0.0;
  Timer? _playbackTimer;
  bool _isPlaying = false;
  bool _isSearching = false;
  String _searchQuery = '';
  String _selectedGenre = 'All';
  int _selectedIndex = 0;

  // State management methods
  void _toggleMyList(int movieId) {
    setState(() {
      if (_myList.contains(movieId)) {
        _myList.remove(movieId);
      } else {
        _myList.add(movieId);
      }
    });
  }

  void _toggleLike(int movieId) {
    setState(() {
      if (_liked.contains(movieId)) {
        _liked.remove(movieId);
      } else {
        _liked.add(movieId);
      }
    });
  }

  void _startPlayback(Movie movie) {
    setState(() {
      _currentlyPlaying = movie;
      _playbackPosition = 0.0;
      _isPlaying = true;
    });
    _startPlaybackTimer();
    _showPlayerModal(movie);
  }

  void _togglePlayPause() {
    setState(() {
      _isPlaying = !_isPlaying;
      if (_isPlaying) {
        _startPlaybackTimer();
      } else {
        _playbackTimer?.cancel();
      }
    });
  }

  void _closePlayback() {
    _playbackTimer?.cancel();
    setState(() {
      _currentlyPlaying = null;
      _playbackPosition = 0.0;
      _isPlaying = false;
    });
  }

  void _startPlaybackTimer() {
    _playbackTimer?.cancel();
    _playbackTimer = Timer.periodic(const Duration(milliseconds: 500), (timer) {
      if (_currentlyPlaying != null && _isPlaying) {
        setState(() {
          _playbackPosition += 0.5;
          if (_playbackPosition >= _currentlyPlaying!.durationSeconds) {
            _closePlayback();
          }
        });
      }
    });
  }

  void _updatePlaybackPosition(double newPosition) {
    setState(() {
      _playbackPosition = newPosition;
    });
  }

  void _onItemTapped(int index) {
    setState(() {
      _selectedIndex = index;
    });
    if (index != 0) {
      _isSearching = false;
      _searchQuery = '';
      _selectedGenre = 'All';
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Navigation to tab ${_getTabName(index)} (Simulated)')),
      );
    }
  }

  String _getTabName(int index) {
    switch (index) {
      case 0:
        return 'Home';
      case 1:
        return 'New & Hot';
      case 2:
        return 'Downloads';
      case 3:
        return 'My Netflix';
      default:
        return '';
    }
  }

  @override
  void dispose() {
    _playbackTimer?.cancel();
    super.dispose();
  }

  // Helper method to filter movies
  List<Movie> _getFilteredMovies() {
    List<Movie> filtered = sampleMovies.where((movie) {
      bool genreMatch = _selectedGenre == 'All' || movie.genres.contains(_selectedGenre);
      bool searchMatch = _searchQuery.isEmpty || movie.title.toLowerCase().contains(_searchQuery.toLowerCase());
      return genreMatch && searchMatch;
    }).toList();

    return filtered;
  }

  // --- Widgets ---

  static const String netflixLogoUrl = 'https://upload.wikimedia.org/wikipedia/commons/thumb/0/08/Netflix_2015_logo.svg/330px-Netflix_2015_logo.svg.png';

  PreferredSizeWidget _buildAppBar() {
    return AppBar(
      automaticallyImplyLeading: false,
      title: Row(
        children: [
          Image.network(
            netflixLogoUrl,
            height: 30,
            errorBuilder: (context, error, stackTrace) =>
                const Text('NETFLIX', style: TextStyle(color: Colors.red, fontSize: 18, fontWeight: FontWeight.bold)),
          ),
          
          const Spacer(),
          if (_isSearching)
            Expanded(
              flex: 3,
              child: Padding(
                padding: const EdgeInsets.symmetric(horizontal: 8.0),
                child: TextField(
                  onChanged: (value) => setState(() => _searchQuery = value),
                  autofocus: true,
                  style: const TextStyle(color: Colors.white),
                  decoration: InputDecoration(
                    hintText: 'Search titles...',
                    hintStyle: const TextStyle(color: Colors.white54),
                    prefixIcon: const Icon(Icons.search, color: Colors.white),
                    suffixIcon: IconButton(
                      icon: const Icon(Icons.close, color: Colors.white),
                      onPressed: () => setState(() {
                        _isSearching = false;
                        _searchQuery = '';
                      }),
                    ),
                    filled: true,
                    fillColor: Colors.grey.shade900,
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8.0),
                      borderSide: BorderSide.none,
                    ),
                    contentPadding: const EdgeInsets.symmetric(vertical: 0, horizontal: 8),
                  ),
                ),
              ),
            ),
          if (!_isSearching)
            IconButton(
              icon: const Icon(Icons.search),
              tooltip: 'Search',
              onPressed: () => setState(() => _isSearching = true),
            ),
          if (!_isSearching)
            IconButton(
              icon: const Icon(Icons.cast),
              tooltip: 'Cast',
              onPressed: () {},
            ),
          Padding(
            padding: const EdgeInsets.only(right: 16.0, left: 8.0),
            child: InkWell(
              onTap: () {},
              borderRadius: BorderRadius.circular(20),
              child: const CircleAvatar(
                backgroundColor: Colors.blueGrey,
                child: Text('U'),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildBody(List<Movie> filteredMovies) {
    if (_selectedIndex != 0) {
      return Center(
        child: Text(
          '${_getTabName(_selectedIndex)} Page (Simulation)',
          style: const TextStyle(color: Colors.white, fontSize: 24),
        ),
      );
    }

    return CustomScrollView(
      slivers: <Widget>[
        SliverToBoxAdapter(child: _buildFeaturedCarousel()),
        SliverPadding(
          padding: const EdgeInsets.symmetric(vertical: 16.0, horizontal: 8.0),
          sliver: SliverToBoxAdapter(child: _buildGenreChips()),
        ),
        if (filteredMovies.isEmpty)
          const SliverToBoxAdapter(
            child: Center(
              child: Padding(
                padding: EdgeInsets.all(32.0),
                child: Text('No titles match your search or filter.', style: TextStyle(color: Colors.white70, fontSize: 16)),
              ),
            ),
          )
        else ...[
          // Top Picks with more movies (7 movies)
          SliverToBoxAdapter(child: _buildMovieRow('Top Picks', filteredMovies.where((m) => [1, 2, 3, 4, 5, 16, 17].contains(m.id)).toList())),
          // Action & Adventure with more movies (8 movies)
          SliverToBoxAdapter(child: _buildMovieRow('Action & Adventure', filteredMovies.where((m) => [6, 7, 8, 9, 10, 18, 19, 20].contains(m.id)).toList())),
          // Your Watchlist with more movies (8 movies)
          SliverToBoxAdapter(child: _buildMovieRow('Your Watchlist', filteredMovies.where((m) => [11, 12, 13, 14, 15, 21, 22, 23].contains(m.id)).toList())),
        ],
        SliverToBoxAdapter(child: SizedBox(height: _currentlyPlaying != null ? 80 : 20)),
      ],
    );
  }

  @override
  Widget build(BuildContext context) {
    final filteredMovies = _getFilteredMovies();

    return Scaffold(
      appBar: _buildAppBar(),
      body: Stack(
        children: [
          _buildBody(filteredMovies),
          if (_currentlyPlaying != null)
            Positioned(
              bottom: 0,
              left: 0,
              right: 0,
              child: Padding(
                padding: const EdgeInsets.only(bottom: 56.0),
                child: _MiniPlayer(
                  movie: _currentlyPlaying!,
                  isPlaying: _isPlaying,
                  position: _playbackPosition,
                  onTogglePlayPause: _togglePlayPause,
                  onClose: _closePlayback,
                  onSliderChanged: _updatePlaybackPosition,
                  onTap: () => _showPlayerModal(_currentlyPlaying!),
                ),
              ),
            ),
        ],
      ),
      bottomNavigationBar: _buildBottomNavBar(),
    );
  }

  Widget _buildBottomNavBar() {
    return BottomNavigationBar(
      items: const <BottomNavigationBarItem>[
        BottomNavigationBarItem(
          icon: Icon(Icons.home_filled),
          label: 'Home',
        ),
        BottomNavigationBarItem(
          icon: Icon(Icons.video_library_outlined),
          label: 'New & Hot',
        ),
        BottomNavigationBarItem(
          icon: Icon(Icons.file_download_outlined),
          label: 'Downloads',
        ),
        BottomNavigationBarItem(
          icon: Icon(Icons.menu),
          label: 'My Netflix',
        ),
      ],
      currentIndex: _selectedIndex,
      selectedItemColor: Colors.white,
      unselectedItemColor: Colors.grey,
      onTap: _onItemTapped,
      backgroundColor: Colors.black,
      type: BottomNavigationBarType.fixed,
    );
  }

  Widget _buildFeaturedCarousel() {
    final featuredMovies = sampleMovies.where((m) => m.rating > 8.5).take(3).toList();
    if (featuredMovies.isEmpty) return const SizedBox.shrink();

    return _CarouselSlider(
      movies: featuredMovies,
      onPosterTap: _showDetailsModal,
    );
  }

  Widget _buildGenreChips() {
    final allGenres = {'All', ...sampleMovies.expand((m) => m.genres)}.toList();
    return SingleChildScrollView(
      scrollDirection: Axis.horizontal,
      padding: const EdgeInsets.symmetric(horizontal: 8.0),
      child: Row(
        children: allGenres.map<Widget>((genre) {
          final isSelected = _selectedGenre == genre;
          return Padding(
            padding: const EdgeInsets.symmetric(horizontal: 4.0),
            child: ActionChip(
              label: Text(genre),
              labelStyle: TextStyle(
                color: isSelected ? Colors.black : Colors.white,
                fontWeight: isSelected ? FontWeight.bold : FontWeight.normal,
              ),
              backgroundColor: isSelected ? Colors.red : Colors.grey.shade800,
              onPressed: () => setState(() => _selectedGenre = genre),
            ),
          );
        }).toList(),
      ),
    );
  }

  Widget _buildMovieRow(String title, List<Movie> movies) {
    if (movies.isEmpty) return const SizedBox.shrink();
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Padding(
          padding: const EdgeInsets.fromLTRB(16.0, 16.0, 16.0, 8.0),
          child: Text(
            title,
            style: const TextStyle(fontSize: 20, fontWeight: FontWeight.bold, color: Colors.white),
          ),
        ),
        SizedBox(
          height: 200,
          child: ListView.builder(
            scrollDirection: Axis.horizontal,
            itemCount: movies.length,
            padding: const EdgeInsets.symmetric(horizontal: 12.0),
            itemBuilder: (context, index) {
              final movie = movies[index];
              return Padding(
                padding: const EdgeInsets.symmetric(horizontal: 4.0),
                child: _MoviePoster(
                  movie: movie,
                  onTap: () => _showDetailsModal(movie),
                ),
              );
            },
          ),
        ),
      ],
    );
  }

  void _showDetailsModal(Movie movie) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) {
        return _DetailsModal(
          movie: movie,
          isInMyList: _myList.contains(movie.id),
          isLiked: _liked.contains(movie.id),
          onToggleMyList: _toggleMyList,
          onToggleLike: _toggleLike,
          onStartPlayback: _startPlayback,
        );
      },
    );
  }

  void _showPlayerModal(Movie movie) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.black,
      builder: (context) {
        return StatefulBuilder(
          builder: (BuildContext context, StateSetter setStateModal) {
            return _FullPlayer(
              movie: _currentlyPlaying ?? movie,
              isPlaying: _isPlaying,
              position: _playbackPosition,
              onTogglePlayPause: () {
                _togglePlayPause();
                setStateModal(() {});
              },
              onSliderChanged: (newPos) {
                _updatePlaybackPosition(newPos);
                setStateModal(() {});
              },
              onClose: () {
                _closePlayback();
                Navigator.pop(context);
              },
            );
          },
        );
      },
    ).then((_) {
      setState(() {});
    });
  }
}

// --- Component Widgets ---

class _MoviePoster extends StatelessWidget {
  final Movie movie;
  final VoidCallback onTap;

  const _MoviePoster({required this.movie, required this.onTap});

  @override
  Widget build(BuildContext context) {
    final String thumbnailUrl = movie.posterUrl.replaceAll('w500', 'w185');

    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(8),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(8),
        child: Image.network(
          thumbnailUrl,
          width: 120,
          fit: BoxFit.cover,
          errorBuilder: (context, error, stackTrace) => Container(
            width: 120,
            color: Colors.grey.shade900,
            alignment: Alignment.center,
            child: const Icon(Icons.broken_image, color: Colors.white54),
          ),
        ),
      ),
    );
  }
}

class _CarouselSlider extends StatefulWidget {
  final List<Movie> movies;
  final Function(Movie) onPosterTap;

  const _CarouselSlider({required this.movies, required this.onPosterTap});

  @override
  State<_CarouselSlider> createState() => _CarouselSliderState();
}

class _CarouselSliderState extends State<_CarouselSlider> {
  final PageController _controller = PageController(viewportFraction: 1.0);
  Timer? _autoScrollTimer;

  @override
  void initState() {
    super.initState();
    if (widget.movies.isNotEmpty) {
      _startAutoScroll();
    }
  }

  void _startAutoScroll() {
    _autoScrollTimer?.cancel();
    _autoScrollTimer = Timer.periodic(const Duration(seconds: 4), (timer) {
      if (_controller.hasClients && _controller.page != null) {
        int currentPage = _controller.page!.round();
        int nextPage = (currentPage + 1) % widget.movies.length;

        _controller.animateToPage(
          nextPage,
          duration: const Duration(milliseconds: 500),
          curve: Curves.easeInOut,
        );
      }
    });
  }

  @override
  void dispose() {
    _autoScrollTimer?.cancel();
    _controller.dispose();
    super.dispose();
  }

  void _goToPage(int page) {
    _autoScrollTimer?.cancel();
    _controller.animateToPage(
      page,
      duration: const Duration(milliseconds: 300),
      curve: Curves.easeOut,
    );
    _startAutoScroll();
  }

  @override
  Widget build(BuildContext context) {
    if (widget.movies.isEmpty) return const SizedBox.shrink();

    return SizedBox(
      height: min(MediaQuery.of(context).size.height * 0.5, 400),
      child: Stack(
        alignment: Alignment.bottomCenter,
        children: [
          PageView.builder(
            controller: _controller,
            itemCount: widget.movies.length,
            itemBuilder: (context, index) {
              final movie = widget.movies[index];
              return GestureDetector(
                onTap: () => widget.onPosterTap(movie),
                child: Stack(
                  fit: StackFit.expand,
                  children: [
                    Image.network(
                      movie.posterUrl.replaceAll('w500', 'original'),
                      fit: BoxFit.cover,
                      errorBuilder: (context, error, stackTrace) => Container(color: Colors.grey.shade900),
                    ),
                    Container(
                      decoration: const BoxDecoration(
                        gradient: LinearGradient(
                          colors: [Colors.transparent, Colors.black87],
                          begin: Alignment.topCenter,
                          end: Alignment.bottomCenter,
                          stops: [0.6, 1.0],
                        ),
                      ),
                    ),
                    Positioned(
                      bottom: 20,
                      left: 20,
                      right: 20,
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            movie.title,
                            style: const TextStyle(
                              fontSize: 32,
                              fontWeight: FontWeight.bold,
                              color: Colors.white,
                              shadows: [Shadow(blurRadius: 3, color: Colors.black)],
                            ),
                          ),
                          const SizedBox(height: 10),
                          ElevatedButton.icon(
                            onPressed: () => widget.onPosterTap(movie),
                            icon: const Icon(Icons.play_arrow),
                            label: const Text('Play'),
                            style: ElevatedButton.styleFrom(
                              backgroundColor: Colors.white,
                              foregroundColor: Colors.black,
                              padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 10),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              );
            },
          ),
          Positioned.fill(
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                IconButton(
                  icon: const Icon(Icons.arrow_back_ios, color: Colors.white, size: 30),
                  onPressed: () {
                    if (_controller.page != null) {
                      int targetPage = (_controller.page!.round() - 1 + widget.movies.length) % widget.movies.length;
                      _goToPage(targetPage);
                    }
                  },
                ),
                IconButton(
                  icon: const Icon(Icons.arrow_forward_ios, color: Colors.white, size: 30),
                  onPressed: () {
                    if (_controller.page != null) {
                      int targetPage = (_controller.page!.round() + 1) % widget.movies.length;
                      _goToPage(targetPage);
                    }
                  },
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}

class _DetailsModal extends StatelessWidget {
  final Movie movie;
  final bool isInMyList;
  final bool isLiked;
  final Function(int) onToggleMyList;
  final Function(int) onToggleLike;
  final Function(Movie) onStartPlayback;

  const _DetailsModal({
    required this.movie,
    required this.isInMyList,
    required this.isLiked,
    required this.onToggleMyList,
    required this.onToggleLike,
    required this.onStartPlayback,
  });

  String _formatDuration(int seconds) {
    int minutes = seconds ~/ 60;
    return '${minutes}m';
  }

  @override
  Widget build(BuildContext context) {
    return Container(
      height: MediaQuery.of(context).size.height * 0.85,
      decoration: const BoxDecoration(
        color: Color(0xFF141414),
        borderRadius: BorderRadius.vertical(top: Radius.circular(16)),
      ),
      child: SingleChildScrollView(
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Stack(
              children: [
                Image.network(
                  movie.posterUrl.replaceAll('w500', 'w780'),
                  height: 250,
                  width: double.infinity,
                  fit: BoxFit.cover,
                  errorBuilder: (context, error, stackTrace) => Container(height: 250, color: Colors.grey.shade900),
                ),
                Positioned(
                  top: 10,
                  right: 10,
                  child: IconButton(
                    icon: const Icon(Icons.close, color: Colors.white),
                    onPressed: () => Navigator.pop(context),
                    style: IconButton.styleFrom(backgroundColor: Colors.black54),
                  ),
                ),
              ],
            ),
            Padding(
              padding: const EdgeInsets.all(16.0),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    movie.title,
                    style: const TextStyle(fontSize: 28, fontWeight: FontWeight.bold, color: Colors.white),
                  ),
                  const SizedBox(height: 8),
                  Row(
                    children: [
                      Text('${movie.year}', style: const TextStyle(color: Colors.green, fontWeight: FontWeight.bold)),
                      const SizedBox(width: 8),
                      Container(
                        padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                        decoration: BoxDecoration(
                          color: Colors.white.withOpacity(0.2),
                          borderRadius: BorderRadius.circular(4),
                        ),
                        child: Text('${movie.rating.toStringAsFixed(1)}', style: const TextStyle(color: Colors.white70, fontSize: 12)),
                      ),
                      const SizedBox(width: 8),
                      Text('â€¢ ${_formatDuration(movie.durationSeconds)}', style: const TextStyle(color: Colors.white70)),
                    ],
                  ),
                  const SizedBox(height: 16),
                  ElevatedButton.icon(
                    onPressed: () {
                      onStartPlayback(movie);
                      Navigator.pop(context);
                    },
                    icon: const Icon(Icons.play_arrow, size: 28),
                    label: const Text('Play', style: TextStyle(fontSize: 18)),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: Colors.white,
                      foregroundColor: Colors.black,
                      minimumSize: const Size(double.infinity, 50),
                    ),
                  ),
                  const SizedBox(height: 16),
                  Text(
                    movie.description,
                    style: const TextStyle(fontSize: 16, color: Colors.white),
                  ),
                  const SizedBox(height: 20),
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceAround,
                    children: [
                      _ActionButton(
                        icon: isInMyList ? Icons.check : Icons.add,
                        label: isInMyList ? 'My List' : 'My List',
                        color: isInMyList ? Colors.red : Colors.white,
                        onTap: () => onToggleMyList(movie.id),
                      ),
                      _ActionButton(
                        icon: isLiked ? Icons.thumb_up : Icons.thumb_up_outlined,
                        label: 'Rate',
                        color: isLiked ? Colors.red : Colors.white,
                        onTap: () => onToggleLike(movie.id),
                      ),
                      _ActionButton(
                        icon: Icons.share_outlined,
                        label: 'Share',
                        color: Colors.white,
                        onTap: () {},
                      ),
                    ],
                  ),
                  const SizedBox(height: 40),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }
}

class _ActionButton extends StatelessWidget {
  final IconData icon;
  final String label;
  final Color color;
  final VoidCallback onTap;

  const _ActionButton({required this.icon, required this.label, required this.color, required this.onTap});

  @override
  Widget build(BuildContext context) {
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(8),
      child: Padding(
        padding: const EdgeInsets.all(8.0),
        child: Column(
          children: [
            Icon(icon, color: color, size: 28),
            const SizedBox(height: 4),
            Text(label, style: TextStyle(color: color, fontSize: 12)),
          ],
        ),
      ),
    );
  }
}

class _MiniPlayer extends StatelessWidget {
  static const double miniPlayerHeight = 60.0;

  final Movie movie;
  final bool isPlaying;
  final double position;
  final VoidCallback onTogglePlayPause;
  final VoidCallback onClose;
  final Function(double) onSliderChanged;
  final VoidCallback onTap;

  const _MiniPlayer({
    required this.movie,
    required this.isPlaying,
    required this.position,
    required this.onTogglePlayPause,
    required this.onClose,
    required this.onSliderChanged,
    required this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    final double progress = position / movie.durationSeconds;
    return Column(
      mainAxisSize: MainAxisSize.min,
      children: [
        SizedBox(
          height: 3.0,
          child: LinearProgressIndicator(
            value: progress.clamp(0.0, 1.0),
            backgroundColor: Colors.grey.shade700,
            valueColor: const AlwaysStoppedAnimation<Color>(Colors.red),
          ),
        ),
        Material(
          color: Colors.grey.shade900,
          child: SizedBox(
            height: miniPlayerHeight - 3.0,
            child: InkWell(
              onTap: onTap,
              child: Padding(
                padding: const EdgeInsets.symmetric(horizontal: 8.0, vertical: 4.0),
                child: Row(
                  children: [
                    ClipRRect(
                      borderRadius: BorderRadius.circular(4),
                      child: Image.network(
                        movie.posterUrl.replaceAll('w500', 'w92'),
                        width: 50,
                        height: 50,
                        fit: BoxFit.cover,
                        errorBuilder: (context, error, stackTrace) => Container(width: 50, height: 50, color: Colors.grey.shade800),
                      ),
                    ),
                    const SizedBox(width: 10),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          Text(
                            movie.title,
                            style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                            overflow: TextOverflow.ellipsis,
                          ),
                          const Text(
                            'Playing Now...',
                            style: TextStyle(color: Colors.white70, fontSize: 12),
                          ),
                        ],
                      ),
                    ),
                    IconButton(
                      icon: Icon(isPlaying ? Icons.pause : Icons.play_arrow, color: Colors.white, size: 30),
                      tooltip: isPlaying ? 'Pause' : 'Play',
                      onPressed: onTogglePlayPause,
                    ),
                    IconButton(
                      icon: const Icon(Icons.close, color: Colors.white, size: 24),
                      tooltip: 'Close Player',
                      onPressed: onClose,
                    ),
                  ],
                ),
              ),
            ),
          ),
        ),
      ],
    );
  }
}

class _FullPlayer extends StatelessWidget {
  final Movie movie;
  final bool isPlaying;
  final double position;
  final VoidCallback onTogglePlayPause;
  final Function(double) onSliderChanged;
  final VoidCallback onClose;

  const _FullPlayer({
    required this.movie,
    required this.isPlaying,
    required this.position,
    required this.onTogglePlayPause,
    required this.onSliderChanged,
    required this.onClose,
  });

  String _formatTime(double seconds) {
    final int minutes = (seconds ~/ 60).toInt();
    final int remainingSeconds = (seconds % 60).toInt();
    final int totalMinutes = (movie.durationSeconds ~/ 60).toInt();
    return '${minutes.toString().padLeft(2, '0')}:${remainingSeconds.toString().padLeft(2, '0')} / ${totalMinutes.toString().padLeft(2, '0')}m';
  }

  @override
  Widget build(BuildContext context) {
    return Container(
      height: MediaQuery.of(context).size.height,
      color: Colors.black,
      child: SafeArea(
        child: Column(
          children: [
            AppBar(
              backgroundColor: Colors.black,
              leading: IconButton(
                icon: const Icon(Icons.arrow_back, color: Colors.white),
                onPressed: onClose,
                tooltip: 'Exit Full Screen',
              ),
              title: Text(movie.title, style: const TextStyle(color: Colors.white)),
              actions: [
                IconButton(
                  icon: const Icon(Icons.cast, color: Colors.white),
                  onPressed: () {},
                ),
              ],
            ),
            Expanded(
              child: Center(
                child: AspectRatio(
                  aspectRatio: 16 / 9,
                  child: Container(
                    color: Colors.black,
                    alignment: Alignment.center,
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        const Icon(Icons.movie, color: Colors.white54, size: 60),
                        const SizedBox(height: 10),
                        const Text('Simulated Video Playback', style: TextStyle(color: Colors.white54)),
                        const SizedBox(height: 20),
                        Row(
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: [
                            IconButton(
                              icon: const Icon(Icons.replay_10, color: Colors.white, size: 40),
                              tooltip: 'Rewind 10 seconds',
                              onPressed: () => onSliderChanged(max(0.0, position - 10)),
                            ),
                            const SizedBox(width: 20),
                            IconButton(
                              icon: Icon(isPlaying ? Icons.pause_circle_filled : Icons.play_circle_filled, color: Colors.white, size: 60),
                              tooltip: isPlaying ? 'Pause' : 'Play',
                              onPressed: onTogglePlayPause,
                            ),
                            const SizedBox(width: 20),
                            IconButton(
                              icon: const Icon(Icons.forward_10, color: Colors.white, size: 40),
                              tooltip: 'Forward 10 seconds',
                              onPressed: () => onSliderChanged(min(movie.durationSeconds.toDouble(), position + 10)),
                            ),
                          ],
                        ),
                      ],
                    ),
                  ),
                ),
              ),
            ),
            Padding(
              padding: const EdgeInsets.all(16.0),
              child: Column(
                children: [
                  Row(
                    children: [
                      Text(
                        _formatTime(position),
                        style: const TextStyle(color: Colors.white),
                      ),
                      const SizedBox(width: 8),
                      Expanded(
                        child: Slider(
                          value: position.clamp(0.0, movie.durationSeconds.toDouble()),
                          min: 0.0,
                          max: movie.durationSeconds.toDouble(),
                          onChanged: onSliderChanged,
                          onChangeEnd: onSliderChanged,
                          activeColor: Colors.red,
                          inactiveColor: Colors.grey.shade700,
                          semanticFormatterCallback: (double value) => 'Current position: ${_formatTime(value)}',
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 10),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }
}
